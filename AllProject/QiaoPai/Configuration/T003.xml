<?xml version="1.0" encoding="utf-8" ?>
<ns0:cng_form xmlns:ns0="http://www.yesno.com.cn/mobile">
    <!--按产品删除-->
    <CONTROL CONTROLTYPE="TEXTBOX" CTL_SHOWIDX="3" GROUP="NF1" HEIGHT="1" ID="DOID">
        <NAME>调拨单号</NAME>
        <FIELDNAME>DOID</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
    </CONTROL>

    <CONTROL CONTROLTYPE="TEXTLONGBOX" CTL_SHOWIDX="3" GROUP="NF1" HEIGHT="1" ID="RECEIVE_UNIT">
        <NAME>收货单位</NAME>
        <FIELDNAME>RECEIVE_UNIT</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
        <INITDATA></INITDATA>
    </CONTROL>

    <!--产品明细列表-->
    <CONTROL CONTROLTYPE="SELECT_VIEW" CTL_SHOWIDX="7" GROUP="NF1" HEIGHT="6" ID="PRODUCT_LIST">
        <NAME>产品明细列表</NAME>
        <FIELDNAME>PRODUCT_LIST</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
        <SEL_VAL>1:T003_PROID</SEL_VAL>
        <INITDATA>
            <ACTION ATYPE="UI" TARGET="PRODUCT_LIST">DISABLE</ACTION>
            <INIT IID="01" OTYPE="DATABASE">
                SELECT DISTINCT '' AS '产品名称',
                '' as '计划',
                '' AS '已扫'
                From T_TEMP WHERE F1='T_TEMP'
            </INIT>
            <INIT IID="02" OTYPE="INIT_NOT_DATABASE">
                SELECT OUTPRO_NAME as '产品名称',
                CAST(F6 as int) || F4 as '计划',
                (SELECT CASE WHEN COUNT(1)>0 THEN SUM(C.F2)||'箱' ELSE '0箱' END FROM T_PDM_CHECKOUT_ALLOT C WHERE C.DoID ='$DOID' and C.OUTPRO_NAME
                =P.OUTPRO_NAME) as '已扫' From T_PDM_SENDSTORE_ALLOT P WHERE DoID='$DOID'
            </INIT>
        </INITDATA>
    </CONTROL>

    <CONTROL CONTROLTYPE="BUTTON" CTL_SHOWIDX="5" GROUP="NF3" HEIGHT="1" ID="BTN_DELETE">
        <NAME>确定删除</NAME>
        <ALLOWINPUT>TRUE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
        <VALIDATE>
            <CONFIRM>KEY_ENTER</CONFIRM>
            <V VID="02" VTYPE="DATABASE">
                <VVALUE>SELECT LENGTH('@T003_PROID')>0</VVALUE>
                <VFAIL MTYPE="ERROR">请选择产品后再进行删除操作！</VFAIL>
            </V>
            <V VID="03" VTYPE="DATABASE">
                <VVALUE>
                    SELECT COUNT(1)>0 FROM T_PDM_CHECKOUT_ALLOT WHERE OUTPRO_NAME='@T003_PROID' AND DoID=':DOID'
                </VVALUE>
                <VFAIL MTYPE="ERROR">当前产品扫描数量为空！</VFAIL>
            </V>
            <V VID="05" VTYPE="ISNULL">
                <VVALUE>DOID</VVALUE>
                <VFAIL MTYPE="QUESTION">确定要进行删除操作吗？</VFAIL>
            </V>
        </VALIDATE>
        <V_OK>
            <ACTION ATYPE="SAVEDATA">F1</ACTION>
            <ACTION ATYPE="SETSHAREPARAM">T003_PROID=</ACTION>
            <ACTION ATYPE="MESSAGE" TARGET="INFO">产品删除成功！</ACTION>
            <ACTION ATYPE="DATASET" TARGET="PRODUCT_LIST">INIT</ACTION>
            <NEXTCONTROL>BTN_CLOSE</NEXTCONTROL>
        </V_OK>
        <V_FALSE></V_FALSE>
    </CONTROL>

    <CONTROL CONTROLTYPE="BUTTON" CTL_SHOWIDX="7" GROUP="NF0" HEIGHT="1" ID="BTN_CLOSE">
        <NAME>退出</NAME>
        <INITDATA>
            <!--判断本地存不存在该单据信息-->
            <ACTION ATYPE="SETDBPARAM">SELECT COUNT(0) as CNT FROM T_PDM_SENDSTORE_ALLOT WHERE DoID IS NOT NULL</ACTION>
            <CONDITION ID="01" VAL="NOT('$CNT'='0')">
                <ACTION ATYPE="SETDBPARAM">
                    SELECT RMF_NAME AS RMF_NAME,DoID AS DOID FROM T_PDM_SENDSTORE_ALLOT WHERE DoID IS NOT NULL LIMIT 1
                </ACTION>
                <ACTION ATYPE="SETVALUE" TARGET="DOID">$DOID</ACTION>
                <ACTION ATYPE="SETVALUE" TARGET="RECEIVE_UNIT">$RMF_NAME</ACTION>
                <ACTION ATYPE="DATASET" TARGET="PRODUCT_LIST">INIT</ACTION>
                <NEXTCONTROL>BTN_CLOSE</NEXTCONTROL>
                <ACTION ATYPE="GOTO" TARGET="END"></ACTION>
            </CONDITION>
            <CONDITION ID="02" VAL="'$CNT'='0'">
                <NEXTCONTROL>BTN_CLOSE</NEXTCONTROL>
                <ACTION ATYPE="GOTO" TARGET="END"></ACTION>
            </CONDITION>
        </INITDATA>
        <VALIDATE>
            <CONFIRM>KEY_ENTER</CONFIRM>
            <V VID="02" VTYPE="ISNULL">
                <VVALUE>DOID</VVALUE>
                <VFAIL MTYPE="QUESTION">确定要退出吗？</VFAIL>
            </V>
        </VALIDATE>
        <V_OK>
            <ACTION ATYPE="SETSHAREPARAM">T003_PROID=</ACTION>
            <ACTION ATYPE="DATASET" TARGET="T003_PACKDELETE">CLOSE</ACTION>
        </V_OK>
        <V_FALSE>
            <NEXTCONTROL>BarCode</NEXTCONTROL>
        </V_FALSE>
    </CONTROL>

    <CONTROL CONTROLTYPE="FORM" CTL_SHOWIDX="0" GROUP="NF1" HEIGHT="1" ID="T003_PACKDELETE">
        <NAME>按产品删除</NAME>
        <VALIDATE>
            <CONFIRM>LOAD</CONFIRM>
            <V VID="01" VTYPE="DATABASE">
                <VVALUE>select COUNT(1)>0 FROM T_PDM_CHECKOUT_ALLOT WHERE DoID IS NOT NULL</VVALUE>
                <VFAIL MTYPE="INFO">还没有扫描数据，请扫描后再操作！</VFAIL>
            </V>
        </VALIDATE>
        <V_OK>
            <ACTION ATYPE="SETSHAREPARAM">T003_PROID=</ACTION>
        </V_OK>
        <V_FALSE>
            <ACTION ATYPE="DATASET" TARGET="T003_PACKDELETE">CLOSE</ACTION>
        </V_FALSE>
    </CONTROL>

    <SAVEDATA>
        <FSAVE ID="F1">
            DELETE FROM T_PDM_CHECKOUT_ALLOT WHERE OUTPRO_NAME ='@T003_PROID' AND DoID=':DOID'
        </FSAVE>
    </SAVEDATA>


</ns0:cng_form>