<?xml version="1.0" encoding="utf-8" ?>
<ns0:cng_form xmlns:ns0="http://www.yesno.com.cn/mobile">
    <!-- 箱垛包装 T_PDM_CODE_CB -->

    <CONTROL CONTROLTYPE="TEXTBOX" CTL_SHOWIDX="8" GROUP="NF2" HEIGHT="1" ID="CODE_ID">
        <NAME>箱 码</NAME>
        <FIELDNAME>CODE_ID</FIELDNAME>
        <ALLOWINPUT>TRUE</ALLOWINPUT>
        <ALLOWSCAN>TRUE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
        <VALIDATE>
            <ACTION ATYPE="DECODE">:CODE_ID</ACTION>
            <CONFIRM>KEY_ENTER</CONFIRM>
            <V VID="01" VTYPE="ISNOTNULL">
                <VVALUE>CODE_ID</VVALUE>
                <VFAIL MTYPE="INFO">箱码不能为空!</VFAIL>
            </V>
            <V VID="02" VTYPE="DATABASE">
                <VVALUE>SELECT LENGTH(':CODE_ID') = 20</VVALUE>
                <VFAIL MTYPE="ERROR">箱码只能是20位数字!</VFAIL>
            </V>
            <V VID="03" VTYPE="DATABASE">
                <VVALUE>SELECT COUNT(0)=0 FROM T_PDM_CODE_CB WHERE F3=':CODE_ID'</VVALUE>
                <VFAIL MTYPE="INFO">该箱码已被扫描!</VFAIL>
            </V>
        </VALIDATE>
        <V_OK>
            <ACTION ATYPE="SAVEDATA">F6</ACTION>
            <ACTION ATYPE="SAVEDATA">F7</ACTION>
            <ACTION ATYPE="SAVEDATA">F2</ACTION>
            <ACTION ATYPE="GET_REMOTE_DATA" TARGET="code/v1✈0✈POSTCUSTOM_SERVICEcode❤:CODE_ID"></ACTION>
            <ACTION ATYPE="SETDBPARAM">
                select F1 as '{STATUS}',F2 as '{MESSAGE}'
                from T_TEMP union all
                select 0 as '{STATUS}','通讯失败' as '{MESSAGE}' limit 0,1
            </ACTION>

            <!--失败-->
            <CONDITION ID="01" VAL="'${STATUS}'='0'">
                <ACTION ATYPE="MESSAGE" TARGET="ERROR">码中台数据返回异常！</ACTION>
                <ACTION ATYPE="DATASET" TARGET="CODE_ID">CLEAR</ACTION>
                <NEXTCONTROL>CODE_ID</NEXTCONTROL>
                <ACTION ATYPE="GOTO" TARGET="END"></ACTION>
            </CONDITION>
            <!--成功-->
            <CONDITION ID="02" VAL="NOT('${STATUS}'='0')">
                <!-- <ACTION ATYPE="BEEP">Success.wav</ACTION>-->
                <ACTION ATYPE="SAVEDATA">F3</ACTION>
                <ACTION ATYPE="SETDBPARAM">
                    SELECT OPERATOR_NO as X_MID ,F2 AS X_batch_ID from T_PDM_CODE_CB
                </ACTION>
                <!--<ACTION ATYPE="SETVALUE" TARGET="MID">$X_MID</ACTION>
                <ACTION ATYPE="SETVALUE" TARGET="batch_ID">$X_batch_ID</ACTION>-->
                <ACTION ATYPE="DATASET" TARGET="PRODUCT_LIST">INIT</ACTION>
                <ACTION ATYPE="DATASET" TARGET="CODE_ID">CLEAR</ACTION>
                <NEXTCONTROL>CODE_ID</NEXTCONTROL>
            </CONDITION>
        </V_OK>
        <V_FALSE>
            <ACTION ATYPE="DATASET" TARGET="CODE_ID">CLEAR</ACTION>
            <NEXTCONTROL>CODE_ID</NEXTCONTROL>
        </V_FALSE>
    </CONTROL>

    <!--产品明细列表-->
    <CONTROL CONTROLTYPE="READONLYVIEW" CTL_SHOWIDX="7" GROUP="NF1" HEIGHT="6" ID="PRODUCT_LIST">
        <NAME>产品明细列表</NAME>
        <FIELDNAME>PRODUCT_LIST</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
        <INITDATA>
            <ACTION ATYPE="UI" TARGET="PRODUCT_LIST">DISABLE</ACTION>
            <INIT IID="01" OTYPE="DATABASE">
                SELECT DISTINCT '' AS '箱码',
                '' AS 'MID',
                '' AS '状态'
                From T_TEMP WHERE F1='T_TEMP'
            </INIT>
            <INIT IID="02" OTYPE="INIT_NOT_DATABASE">
                SELECT F3 as '箱码',OPERATOR_NO as 'MID',
                case when F10='1' then '√' else 'x' end AS '状态'
                FROM T_PDM_CODE_CB
            </INIT>
        </INITDATA>
    </CONTROL>


    <CONTROL CONTROLTYPE="BUTTONBGROUP" CTL_SHOWIDX="3" GROUP="BG1" HEIGHT="1" ID="BTG">
        <NAME>多个按钮</NAME>
        <FIELDNAME>BTG</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
    </CONTROL>

    <CONTROL CONTROLTYPE="BUTTON" CTL_SHOWIDX="12" GROUP="BG1" HEIGHT="1" ID="BTN_DIS">
        <NAME>完成包装</NAME>
        <FIELDNAME>BTN_DIS</FIELDNAME>
        <ALLOWINPUT>TRUE</ALLOWINPUT>
        <VALIDATE>
            <CONFIRM>KEY_ENTER</CONFIRM>
            <V VID="01" VTYPE="DATABASE">
                <VVALUE>SELECT COUNT(1)>0 FROM T_PDM_CODE_CB</VVALUE>
                <VFAIL MTYPE="ERROR">扫描数量为空，请先扫描数码！</VFAIL>
            </V>
            <V VID="02" VTYPE="DATABASE">
                <VVALUE>SELECT case when OPERATOR_NAME ='done' then 0 else 1 end FROM T_PDM_CODE_CB</VVALUE>
                <VFAIL MTYPE="ERROR">请重新扫描数码后再进行重组操作！</VFAIL>
            </V>
            <V VID="03" VTYPE="DATABASE">
                <VVALUE>SELECT COUNT(1)&lt;0 FROM T_PDM_CODE_CB</VVALUE>
                <VFAIL MTYPE="QUESTION">确定要完成当前箱垛重组吗？</VFAIL>
            </V>
        </VALIDATE>
        <V_OK>
            <ACTION ATYPE="SETPARAM">JUDGE_CHANGE=false</ACTION>
              <ACTION ATYPE="SAVEDATA">F2</ACTION>
            <ACTION ATYPE="SETDBPARAM">
                SELECT CODE3 as X_parentCode,CODE4 as X_productId,GROUP_CONCAT(CODE1) AS CODELIST FROM T_PDM_CODE_CB WHERE F10='1'
            </ACTION>
            <!--类型❤parentCode❤productId❤code[]-->
            <!-- <ACTION ATYPE="SETPARAMAR_XXX">ZU_DUO❤XNDM20200316000001❤1439❤11111,3333,10048538981</ACTION>-->
            <ACTION ATYPE="SETPARAMAR_XXX">ZU_DUO❤$X_parentCode❤$X_productId❤$CODELIST</ACTION>
            <ACTION ATYPE="GET_REMOTE_DATA" TARGET="change/v1/assemble/stamp✈POSTCUSTOM_SERVICE$ARRAY_XXX"></ACTION>
            <ACTION ATYPE="SETDBPARAM">
                select F1 as '{STATUS}',F2 as '{MESSAGE}'
                from T_TEMP union all
                select 0 as '{STATUS}','通讯失败' as '{MESSAGE}' limit 0,1
            </ACTION>
            <!--<ACTION ATYPE="SETDBPARAM">
                select F1 as '{STATUS}',case when F4 is null then F2 else F4 end as '{MESSAGE}'
                from T_TEMP union all
                select 0 as '{STATUS}','通讯失败' as '{MESSAGE}' limit 0,1
            </ACTION>-->

            <CONDITION ID="01" VAL="'${STATUS}'='0'">
                <ACTION ATYPE="MESSAGE" TARGET="INFO">${MESSAGE}</ACTION>
                <ACTION ATYPE="DATASET" TARGET="CODE">CLEAR</ACTION>
                <ACTION ATYPE="GOTO" TARGET="END"></ACTION>
            </CONDITION>

            <!--T_Temp表字段含义：
            F1 allNum所有数码数量
            F2 code 异常数码
            F3 codeType
            F4 异常信息：该码为无效码，请重新扫码
            F5 productId
            F6 productName
            F7 successNum 成功数量-->
            <CONDITION ID="02" VAL="NOT('${STATUS}'='0')">
                <!--F1 allNum  F2 productId  F3 产品名称  F4 successNum-->
                <ACTION ATYPE="SETDBPARAM">
                    SELECT F1 as X_allNum,F7 as X_successNum FROM T_TEMP
                </ACTION>
                <ACTION ATYPE="SAVEDATA">F8</ACTION>
            </CONDITION>

            <!-- <ACTION ATYPE="PRINTLOG">$X_successNum</ACTION>-->
            <!--全部成功-->
            <CONDITION ID="03" VAL="NOT('${STATUS}'='0') AND $X_successNum >= $X_allNum">
                <ACTION ATYPE="MESSAGE" TARGET="INFO">组垛成功！</ACTION>
                <NEXTCONTROL>CODE_ID</NEXTCONTROL>
                <!--修改码是否组成功的状态-->
                <ACTION ATYPE="SAVEDATA">F10</ACTION>
                <!--删除、存储失败数码表 -->
                <ACTION ATYPE="SAVEDATA">F7</ACTION>
                <ACTION ATYPE="GOTO" TARGET="END"></ACTION>
            </CONDITION>

            <!--存在失败-->
            <CONDITION ID="04" VAL="NOT('${STATUS}'='0') AND $X_allNum > $X_successNum">
                <ACTION ATYPE="SHOWCONFIRM" TARGET="QUESTION_YES">部分数码组跺失败，查看失败原因！</ACTION>
                <!--修改码是否组成功的状态-->
                <ACTION ATYPE="SAVEDATA">F5</ACTION>
                <!--删除、存储失败数码表 -->
                <ACTION ATYPE="SAVEDATA">F7</ACTION>
                <ACTION ATYPE="SAVEDATA">F4</ACTION>
            </CONDITION>


            <CONDITION ID="05" VAL="'$JUDGE_CHANGE'='false'">
                <ACTION ATYPE="DATASET" TARGET="PRODUCT_LIST">INIT</ACTION>
                <NEXTCONTROL>CODE_ID</NEXTCONTROL>
                <ACTION ATYPE="GOTO" TARGET="END"></ACTION>
            </CONDITION>

            <CONDITION ID="06" VAL="NOT('${STATUS}'='0') AND '$JUDGE_CHANGE'='true'">
                <ACTION ATYPE="UI" TARGET="N001_2">SHOW_FORM</ACTION>
                <ACTION ATYPE="DATASET" TARGET="PRODUCT_LIST">INIT</ACTION>
                <NEXTCONTROL>CODE_ID</NEXTCONTROL>
            </CONDITION>

        </V_OK>
        <V_FALSE>
            <ACTION ATYPE="DATASET" TARGET="PRODUCT_CODE">CLEAR</ACTION>
            <NEXTCONTROL>PRODUCT_CODE</NEXTCONTROL>
        </V_FALSE>
    </CONTROL>

    <CONTROL CONTROLTYPE="BUTTON" CTL_SHOWIDX="12" GROUP="BG1" HEIGHT="1" ID="BTN_EN">
        <NAME>删除箱码</NAME>
        <FIELDNAME>BTN_EN</FIELDNAME>
        <ALLOWINPUT>TRUE</ALLOWINPUT>
        <VALIDATE>
            <CONFIRM>CHANGE|KEY_ENTER</CONFIRM>
        </VALIDATE>
        <V_OK>
            <!--判断本地存不存在该单据信息-->
            <ACTION ATYPE="SETDBPARAM">SELECT COUNT(0) as CNT FROM T_PDM_CODE_CB WHERE CODE1 IS NOT NULL</ACTION>

            <CONDITION ID="01" VAL="NOT('$CNT'='0')">
                <ACTION ATYPE="UI" TARGET="N001_1">SHOW_FORM</ACTION>
                <ACTION ATYPE="DATASET" TARGET="PRODUCT_LIST">INIT</ACTION>
                <NEXTCONTROL>CODE_ID</NEXTCONTROL>
                <ACTION ATYPE="GOTO" TARGET="END"></ACTION>
            </CONDITION>

            <CONDITION ID="02" VAL="'$CNT'='0'">
                <ACTION ATYPE="MESSAGE" TARGET="INFO">没有可删除的数据！</ACTION>
                <NEXTCONTROL>CODE_ID</NEXTCONTROL>
                <ACTION ATYPE="GOTO" TARGET="END"></ACTION>
            </CONDITION>

        </V_OK>
        <V_FALSE></V_FALSE>
    </CONTROL>


    <!--查看失败数码-->
    <CONTROL CONTROLTYPE="BUTTON" CTL_SHOWIDX="11" GROUP="NF1" HEIGHT="1" ID="BTN_DELETECODE">
        <NAME>查看失败数码</NAME>
        <VALIDATE>
            <CONFIRM>KEY_ENTER</CONFIRM>
            <V VID="01" VTYPE="DATABASE">
                <VVALUE>SELECT COUNT(0)!=0 FROM T_PDM_INCODE</VVALUE>
                <VFAIL MTYPE="ERROR">当前无错误数码！</VFAIL>
            </V>
        </VALIDATE>
        <V_OK>
            <ACTION ATYPE="UI" TARGET="N001_2">SHOW_FORM</ACTION>
            <ACTION ATYPE="DATASET" TARGET="PRODUCT_LIST">INIT</ACTION>
            <NEXTCONTROL>CODE_ID</NEXTCONTROL>
        </V_OK>
        <V_FALSE>

        </V_FALSE>
    </CONTROL>

    <CONTROL CONTROLTYPE="BUTTON" CTL_SHOWIDX="11" GROUP="NF1" HEIGHT="1" ID="BTN_RESET">
        <NAME>重置</NAME>
        <VALIDATE>
            <CONFIRM>KEY_ENTER</CONFIRM>
            <V VID="01" VTYPE="ISNULL">
                <VVALUE>PRODUCT_LIST</VVALUE>
                <VFAIL MTYPE="QUESTION">重置将会清除所有数据，确定要重置吗？</VFAIL>
            </V>
        </VALIDATE>
        <V_OK>
            <ACTION ATYPE="SAVEDATA">F1</ACTION>
            <ACTION ATYPE="SAVEDATA">F7</ACTION>
            <ACTION ATYPE="DATASET" TARGET="PRODUCT_LIST">CLEAR</ACTION>
            <NEXTCONTROL>CODE_ID</NEXTCONTROL>
        </V_OK>
        <V_FALSE>

        </V_FALSE>
    </CONTROL>


    <CONTROL CONTROLTYPE="BUTTON" CTL_SHOWIDX="9" GROUP="NF0" HEIGHT="1" ID="BTN_CLOSE">
        <NAME>退出</NAME>
        <VALIDATE>
            <CONFIRM>KEY_ENTER</CONFIRM>
        </VALIDATE>
        <V_OK>
            <ACTION ATYPE="SAVEDATA">F1</ACTION>
            <ACTION ATYPE="SAVEDATA">F7</ACTION>
            <ACTION ATYPE="DATASET" TARGET="N001">CLOSE</ACTION>
        </V_OK>
        <V_FALSE>

        </V_FALSE>
    </CONTROL>

    <CONTROL CONTROLTYPE="FORM" CTL_SHOWIDX="0" GROUP="NF1" HEIGHT="1" ID="N001">
        <NAME>箱垛重组</NAME>
        <VALIDATE>
            <CONFIRM>LOAD</CONFIRM>
        </VALIDATE>
        <V_FALSE>

        </V_FALSE>
    </CONTROL>

    <SAVEDATA>

        <FSAVE ID='F2'>
            DELETE FROM T_TEMP
        </FSAVE>

        <!--T_PDM_CODE_CB 字段含义：
        CODE1 码序号
        OPERATOR_NO 产品编号
        CODE2 eseTagId
        CODE3 parentCode
        CODE4 productID
        F1 子码数量
        F2 批次ID
        F3 箱码-->
        <!--[{"code":"10082223266","codeLevel":2,"codeType":"URL","eseTagId":"1081751241","parentCode":"5d19319f-90b0-4d5b-bac2-0c61a36d719f","productCode":"550058692","productId":611,"subNum":4,"tagBatchId":"11332","txBoxCode":"00000000001081751241"}]-->
        <FSAVE ID="F3">
            INSERT INTO T_PDM_CODE_CB (CODE1,OPERATOR_NO,CODE2,CODE3,CODE4,F1,F2,F3,F10)
            SELECT F1,F6,F4,F5,F7,F8,F9,F10,'1' FROM T_TEMP
        </FSAVE>

        <FSAVE ID='F1'>
            DELETE FROM T_PDM_CODE_CB
        </FSAVE>

        <!--更新F10的码状态-->
        <FSAVE ID="F5">
            UPDATE T_PDM_CODE_CB SET F10='0',F9='3' where CODE2 = (SELECT F2 FROM T_TEMP where F2=T_PDM_CODE_CB.CODE2)
        </FSAVE>

        <!--全部成功，把F9全部改为3，便于在当前页面再次扫描时进行删除-->
        <FSAVE ID="F10">
            UPDATE T_PDM_CODE_CB SET F9='3'
        </FSAVE>

        <!--存储异常数码表：F5 productID，F1 异常数码  F2 异常信息   F3 产品名称-->
        <FSAVE ID="F4">
            INSERT INTO T_PDM_INCODE(DoID,F1,F2,F3,OUTPRO_ZID,SCANER_NO) SELECT t.F5,t.F2,t.F4,t.F6,'1',s.F3 FROM T_TEMP t
            INNER JOIN T_PDM_CODE_CB s on t.F2=s.CODE2
        </FSAVE>
        <!-- 删除上次完成的数码 -->
        <FSAVE ID="F6">
            DELETE FROM T_PDM_CODE_CB where F9='3'
        </FSAVE>

        <FSAVE ID="F8">
            UPDATE T_PDM_CODE_CB SET OPERATOR_NAME='done'
        </FSAVE>

        <FSAVE ID="F7">
            DELETE FROM T_PDM_INCODE
        </FSAVE>

    </SAVEDATA>
</ns0:cng_form>
