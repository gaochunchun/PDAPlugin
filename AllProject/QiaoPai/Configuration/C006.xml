<?xml version="1.0" encoding="utf-8"?>
<ns0:cng_form xmlns:ns0="http://www.yesno.com.cn/mobile">
    <!--订单查询 22020051917324839-->
    <!--4-计划 5-进行中 6-已完成 7-关闭-->
    <CONTROL CONTROLTYPE="RADIOGROUP" CTL_SHOWIDX="1" GROUP="NF2" HEIGHT="1" ID="CODETYPE">
        <NAME>查询类型</NAME>
        <FIELDNAME>CODETYPE</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
        <INITDATA>
            <INIT IID="01" OTYPE="DATABASE">
                SELECT '4,5' as ItemId, '未完成' as ItemValue
                union
                SELECT '6' as ItemId, '已完成' as ItemValue
            </INIT>
        </INITDATA>
        <V_OK>
            <ACTION ATYPE="UI" TARGET="CODETYPE">ENABLE</ACTION>
            <ACTION ATYPE="UI" TARGET="DOID">ENABLE</ACTION>
            <NEXTCONTROL>DOID</NEXTCONTROL>
        </V_OK>
        <V_FALSE></V_FALSE>
    </CONTROL>

    <CONTROL CONTROLTYPE="TEXTBOX" CTL_SHOWIDX="1" GROUP="NF1" HEIGHT="1" ID="DOID">
        <NAME>出库单号</NAME>
        <FIELDNAME>DOID</FIELDNAME>
        <ALLOWINPUT>TRUE</ALLOWINPUT>
        <ALLOWSCAN>TRUE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
        <VALIDATE>
            <ACTION ATYPE="SETPARAM">SUBSTR_DOID=</ACTION>
            <ACTION ATYPE="DECODE" TARGET="SUBSTR">:DOID</ACTION>
            <CONFIRM>KEY_ENTER</CONFIRM>
            <V VID="01" VTYPE="ISNOTNULL">
                <VVALUE>DOID</VVALUE>
                <VFAIL MTYPE="INFO">出库单号不能为空！</VFAIL>
            </V>
            <V VID="03" VTYPE="REGEX">
                <VVALUE>:DOID#^(\d{9}|\d{10}|\d{16})$</VVALUE>
                <VFAIL MTYPE="INFO">单号只能是9位或10位数字！</VFAIL>
            </V>
        </VALIDATE>

        <V_OK>
            <ACTION ATYPE="SETDBPARAM">
                SELECT CASE WHEN LENGTH(':DOID')=9 THEN '0:DOID'
                WHEN LENGTH(':DOID')=16 THEN '0$SUBSTR_DOID'
                ELSE ':DOID' END as ORDER_CODE
            </ACTION>
            <ACTION ATYPE="SETVALUE" TARGET="DOID">$ORDER_CODE</ACTION>
            <!--
         T_TEMP表中字段含义：
         F17 OUT_SELE(销售出库),OUT_TRANSFER(调拨出库)
         F13 status 订单状态 4-计划 5-进行中 6-已完成 7-关闭
         F10 收货单位
         F7 出库单号
         F9 receiveId
         F15 productId
         F16 产品名称
         F4 订单实际数量 actualNum
         F6 id
         F1 actualNum 实扫数量
         F2 codeLevel 层级
         F3 levelName（如：箱）
         F8 订单总箱数
         F14 计划
         F10 收货方-->
            <ACTION ATYPE="SAVEDATA">F6</ACTION>
            <ACTION ATYPE="GET_REMOTE_DATA" TARGET="order/v1/out✈GETCUSTOM_SERVICEorderCode❤:DOID|status❤:CODETYPE"></ACTION>
            <ACTION ATYPE="SETDBPARAM">
                select case when F6 is null then F1 else F6 end
                as '{STATUS}',F2 as '{MESSAGE}',CASE WHEN LENGTH(F17)=0 OR F17 IS NULL THEN 'ERROR' ELSE F17 END as STORAGE_TYPE,F13 as O_TYPE
                from T_TEMP union all
                select 0 as '{STATUS}','通讯失败' as '{MESSAGE}','','0' limit 0,1
            </ACTION>
            <CONDITION ID="01" VAL="'${STATUS}'='0'">
                <ACTION ATYPE="MESSAGE" TARGET="INFO">${MESSAGE}</ACTION>
                <ACTION ATYPE="DATASET" TARGET="SCANTIP">CLEAR</ACTION>
                <ACTION ATYPE="DATASET" TARGET="SHOUHUO">CLEAR</ACTION>
                <ACTION ATYPE="DATASET" TARGET="ALLNUM">CLEAR</ACTION>
                <ACTION ATYPE="DATASET" TARGET="CHUKU_NUM">CLEAR</ACTION>
                <ACTION ATYPE="DATASET" TARGET="SHOULD_SCAN">CLEAR</ACTION>
                <ACTION ATYPE="DATASET" TARGET="DOID">CLEAR</ACTION>
                <NEXTCONTROL>DOID</NEXTCONTROL>
                <ACTION ATYPE="GOTO" TARGET="END" />
            </CONDITION>
            <!--OUT_SELE(销售出库),OUT_TRANSFER(调拨出库)-->
            <CONDITION ID="02" VAL="NOT('${STATUS}'='0') AND '$STORAGE_TYPE'='ERROR' || '$STORAGE_TYPE'='OUT_TRANSFER'">
                <ACTION ATYPE="MESSAGE" TARGET="INFO">单据类型不匹配，请重新扫描！</ACTION>
                <ACTION ATYPE="DATASET" TARGET="SCANTIP">CLEAR</ACTION>
                <ACTION ATYPE="DATASET" TARGET="SHOUHUO">CLEAR</ACTION>
                <ACTION ATYPE="DATASET" TARGET="ALLNUM">CLEAR</ACTION>
                <ACTION ATYPE="DATASET" TARGET="CHUKU_NUM">CLEAR</ACTION>
                <ACTION ATYPE="DATASET" TARGET="SHOULD_SCAN">CLEAR</ACTION>
                <ACTION ATYPE="DATASET" TARGET="DOID">CLEAR</ACTION>
                <NEXTCONTROL>DOID</NEXTCONTROL>
                <ACTION ATYPE="GOTO" TARGET="END" />
            </CONDITION>
            <CONDITION ID="03" VAL="NOT('${STATUS}'='0') AND NOT('$STORAGE_TYPE'='') AND '$STORAGE_TYPE'='OUT_SELE'">
                <!-- <ACTION ATYPE="BEEP">Success.wav</ACTION>-->
                <ACTION ATYPE="SETDBPARAM">
                    SELECT F12 as DOID,F10 as X_SHOUHUO,F8 as X_planNum,F4 as X_actualNum FROM T_TEMP WHERE F12=':DOID'
                </ACTION>
                <ACTION ATYPE="SETVALUE" TARGET="SCANTIP">:DOID</ACTION>
                <ACTION ATYPE="SETVALUE" TARGET="SHOUHUO">$X_SHOUHUO</ACTION>
                <ACTION ATYPE="SETVALUE" TARGET="ALLNUM">$X_planNum</ACTION>
                <ACTION ATYPE="SETVALUE" TARGET="CHUKU_NUM">$X_actualNum</ACTION>
                <ACTION ATYPE="DATASET" TARGET="SHOULD_SCAN">INIT</ACTION>
                <ACTION ATYPE="DATASET" TARGET="DOID">CLEAR</ACTION>
                <NEXTCONTROL>DOID</NEXTCONTROL>
            </CONDITION>
        </V_OK>

        <V_FALSE>
            <ACTION ATYPE="DATASET" TARGET="DOID">CLEAR</ACTION>
            <NEXTCONTROL>DOID</NEXTCONTROL>
        </V_FALSE>
    </CONTROL>


    <!--已扫单号-->
    <CONTROL CONTROLTYPE="TEXTBOX" CTL_SHOWIDX="5" GROUP="NF1" HEIGHT="1" ID="SCANTIP">
        <NAME>已扫单号</NAME>
        <FIELDNAME>SCANTIP</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
    </CONTROL>

    <CONTROL CONTROLTYPE="TEXTLONGBOX" CTL_SHOWIDX="5" GROUP="NF1" HEIGHT="1" ID="SHOUHUO">
        <NAME>收货单位</NAME>
        <FIELDNAME>SHOUHUO</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
    </CONTROL>

    <CONTROL CONTROLTYPE="TEXTBOX" CTL_SHOWIDX="5" GROUP="NF1" HEIGHT="1" ID="ALLNUM">
        <NAME>总数量</NAME>
        <FIELDNAME>ALLNUM</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
    </CONTROL>

    <CONTROL CONTROLTYPE="TEXTBOX" CTL_SHOWIDX="5" GROUP="NF1" HEIGHT="1" ID="CHUKU_NUM">
        <NAME>已出数量</NAME>
        <FIELDNAME>CHUKU_NUM</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
    </CONTROL>

    <CONTROL CONTROLTYPE="TEXTBOX" CTL_SHOWIDX="5" GROUP="NF1" HEIGHT="1" ID="SHOULD_SCAN">
        <NAME>应扫数量</NAME>
        <FIELDNAME>CHUKU_NUM</FIELDNAME>
        <ALLOWINPUT>FALSE</ALLOWINPUT>
        <ALLOWSCAN>FALSE</ALLOWSCAN>
        <ISREADONLY>FALSE</ISREADONLY>
        <INITDATA>
            <INIT IID="01" OTYPE="INIT_NOT_DATABASE">
                SELECT (CAST(F8 AS INT)-CAST(F4 AS INT))||'箱' AS SHOULD_SCAN_NUM FROM T_TEMP
            </INIT>
        </INITDATA>
    </CONTROL>


    <CONTROL CONTROLTYPE="BUTTON" CTL_SHOWIDX="14" GROUP="NF0" HEIGHT="1" ID="BTN_CLOSE">
        <NAME>退出</NAME>
        <INITDATA></INITDATA>
        <VALIDATE>
            <CONFIRM>KEY_ENTER</CONFIRM>
            <V VID="02" VTYPE="ISNULL">
                <VVALUE>SCANTIP</VVALUE>
                <VFAIL MTYPE="QUESTION">确定要退出吗？</VFAIL>
            </V>
        </VALIDATE>
        <V_OK>
            <ACTION ATYPE="DATASET" TARGET="C006">CLOSE</ACTION>
        </V_OK>
        <V_FALSE>
            <NEXTCONTROL>DOID</NEXTCONTROL>
        </V_FALSE>
    </CONTROL>


    <CONTROL CONTROLTYPE="FORM" CTL_SHOWIDX="0" GROUP="NF1" HEIGHT="1" ID="C006">
        <NAME>订单查询</NAME>
        <VALIDATE>
            <CONFIRM>LOAD</CONFIRM>
        </VALIDATE>
        <V_OK></V_OK>

    </CONTROL>
    <SAVEDATA>

        <FSAVE ID="F6">
            DELETE FROM T_TEMP
        </FSAVE>

    </SAVEDATA>
</ns0:cng_form>